<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizarra Colaborativa</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <!-- Tone.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            touch-action: none; /* Prevent scrolling/zooming on canvas for better drawing experience */
        }
        /* Animaci√≥n para el mensaje de guardado */
        @keyframes fade-in-out {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .animate-fade-in-out {
            animation: fade-in-out 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 font-inter antialiased">
    <div id="app-root" class="flex flex-col items-center justify-center min-h-screen p-4">
        <!-- El contenido de la aplicaci√≥n se renderizar√° din√°micamente aqu√≠ por JavaScript -->
    </div>

    <script>
        // Define variables globales para la configuraci√≥n de Firebase y el ID de la aplicaci√≥n
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Variables globales para las instancias de Firebase y el estado de la aplicaci√≥n
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentBoardId = null; // null para la pantalla de inicio, string para el ID del tablero

        // Variables de estado para el tablero de dibujo actual
        let drawing = false;
        let currentStroke = [];
        let strokes = []; // Trazos para el tablero activo actual
        let color = '#000000';
        let brushSize = 5;
        let backgroundImageUrl = null;
        const backgroundImageRef = new Image(); // Referencia al objeto Image para la imagen de fondo

        // Datos de im√°genes de fondo predefinidas
        const backgroundImages = [
            { id: 'person', url: 'https://placehold.co/400x600/aabbcc/ffffff?text=Persona', name: 'Persona üßç' },
            { id: 'house', url: 'https://placehold.co/600x400/ccbbdd/ffffff?text=Casa', name: 'Casa üè†' },
            { id: 'tree', url: 'https://placehold.co/300x500/ddeeff/ffffff?text=Arbol', name: '√Årbol üå≥' },
            { id: 'cloud', url: 'https://placehold.co/500x300/eefaff/000000?text=Nube', name: 'Nube ‚òÅÔ∏è' },
        ];

        // Instancia global de Tone.js Synth para sonidos de clic
        let localSynth = null;

        // --- Inicializaci√≥n de Firebase ---
        async function initializeFirebase() {
            try {
                // Usa las funciones directamente del SDK modular de Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Escucha los cambios de estado de autenticaci√≥n
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Inicia sesi√≥n de forma an√≥nima si no hay ning√∫n usuario conectado
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid; // Asegura que userId se establezca despu√©s del inicio de sesi√≥n
                    }
                    isAuthReady = true;
                    renderApp(); // Vuelve a renderizar la aplicaci√≥n despu√©s de que la autenticaci√≥n est√© lista
                });
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
            }
        }

        // --- Inicializaci√≥n de Tone.js ---
        function initializeSynth() {
            if (typeof Tone !== 'undefined') {
                localSynth = new Tone.Synth().toDestination();
                // No es necesario un m√©todo de dispose en un contexto global para una aplicaci√≥n de una sola p√°gina
            } else {
                console.warn("Tone.js no est√° definido. Los efectos de sonido no funcionar√°n.");
            }
        }

        // Funci√≥n para reproducir un sonido de clic
        function playClickSound() {
            if (localSynth) {
                localSynth.triggerAttackRelease("C4", "8n"); // Reproduce una nota C4 durante una octava
            } else {
                console.warn("Sintetizador no inicializado, no se puede reproducir el sonido.");
            }
        }

        // --- L√≥gica de Dibujo en el Canvas ---
        // Funci√≥n para dibujar un solo trazo en el lienzo
        function drawStroke(context, stroke) {
            if (!context || !stroke || !stroke.points || stroke.points.length < 2) return;

            context.beginPath();
            context.moveTo(stroke.points[0].x, stroke.points[0].y);
            context.strokeStyle = stroke.color;
            context.lineWidth = stroke.brushSize;
            context.lineCap = 'round';
            context.lineJoin = 'round';

            for (let i = 1; i < stroke.points.length; i++) {
                context.lineTo(stroke.points[i].x, stroke.points[i].y);
            }
            context.stroke();
        }

        // Funci√≥n para redibujar todo el contenido del lienzo (fondo y trazos)
        function redrawCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            const context = canvas.getContext('2d');

            // Limpia el lienzo antes de redibujar
            context.clearRect(0, 0, canvas.width, canvas.height);

            // Dibuja la imagen de fondo si est√° disponible y cargada
            if (backgroundImageRef.src && backgroundImageRef.complete) {
                context.drawImage(backgroundImageRef, 0, 0, canvas.width, canvas.height);
            }

            // Dibuja todos los trazos existentes
            strokes.forEach(stroke => {
                drawStroke(context, stroke);
            });

            // Dibuja el trazo actual que est√° siendo dibujado activamente por el usuario
            if (currentStroke.length > 0 && drawing) {
                context.beginPath();
                context.moveTo(currentStroke[0].x, currentStroke[0].y);
                context.strokeStyle = color;
                context.lineWidth = brushSize;
                context.lineCap = 'round';
                context.lineJoin = 'round';
                for (let i = 1; i < currentStroke.length; i++) {
                    context.lineTo(currentStroke[i].x, currentStroke[i].y);
                }
                context.stroke();
            }
        }

        // Funci√≥n para manejar el redimensionamiento del lienzo
        function resizeCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                redrawCanvas(); // Redibuja el contenido despu√©s de redimensionar
            }
        }

        // Maneja el evento de presionar el rat√≥n/tocar para comenzar a dibujar
        function startDrawing(e) {
            if (!userId) {
                console.warn("Usuario no autenticado a√∫n. No se puede iniciar el dibujo.");
                return;
            }
            drawing = true;
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches) { // Para eventos t√°ctiles
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else { // Para eventos de rat√≥n
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            currentStroke = [{ x, y }];
        }

        // Maneja el evento de mover el rat√≥n/tocar para continuar dibujando
        function draw(e) {
            if (!drawing) return;
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            currentStroke.push({ x, y });
            redrawCanvas(); // Redibuja continuamente mientras se dibuja
        }

        // Maneja el evento de soltar el rat√≥n/tocar para detener el dibujo y guardar el trazo en Firestore
        async function stopDrawing() {
            drawing = false;
            if (currentStroke.length > 1 && userId && db && currentBoardId) {
                try {
                    // Usa las funciones de Firestore directamente
                    const strokesCollectionRef = collection(db, `artifacts/${appId}/public/data/boards/${currentBoardId}/strokes`);
                    await addDoc(strokesCollectionRef, {
                        userId: userId,
                        points: JSON.stringify(currentStroke), // Almacena los puntos como cadena JSON
                        color: color,
                        brushSize: brushSize,
                        timestamp: serverTimestamp() // Usa la marca de tiempo del servidor para ordenar
                    });
                } catch (error) {
                    console.error("Error al guardar el trazo:", error);
                }
            }
            currentStroke = []; // Limpia el trazo actual despu√©s de guardar
        }

        // --- Listeners y Operaciones de Firestore ---
        let unsubscribeStrokes = null;
        let unsubscribeSettings = null;

        // Configura los listeners de Firestore para el tablero actual
        function setupBoardListeners(boardId) {
            // Desuscribe los listeners anteriores si existen
            if (unsubscribeStrokes) unsubscribeStrokes();
            if (unsubscribeSettings) unsubscribeSettings();

            // Usa las funciones de Firestore directamente
            const strokesCollectionRef = collection(db, `artifacts/${appId}/public/data/boards/${boardId}/strokes`);
            const q = query(strokesCollectionRef, orderBy('timestamp'));

            // Listener para los trazos
            unsubscribeStrokes = onSnapshot(q, (snapshot) => {
                const fetchedStrokes = [];
                snapshot.forEach((d) => {
                    const data = d.data();
                    fetchedStrokes.push({
                        id: d.id,
                        ...data,
                        points: JSON.parse(data.points) // Asegura que los puntos se analicen de nuevo a un array
                    });
                });
                strokes = fetchedStrokes;
                redrawCanvas();
            }, (error) => {
                console.error(`Error al obtener los trazos para el tablero ${boardId}:`, error);
            });

            // Listener para la configuraci√≥n del tablero (imagen de fondo)
            const boardSettingsDocRef = doc(db, `artifacts/${appId}/public/data/boardSettings`, boardId);
            unsubscribeSettings = onSnapshot(boardSettingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    backgroundImageUrl = data.backgroundImageUrl || null;
                } else {
                    backgroundImageUrl = null;
                }
                // Carga la imagen de fondo si la URL cambia
                if (backgroundImageUrl) {
                    backgroundImageRef.onload = redrawCanvas;
                    backgroundImageRef.onerror = () => {
                        console.error("Error al cargar la imagen de fondo:", backgroundImageUrl);
                        backgroundImageUrl = null; // Limpia la URL en caso de error
                        redrawCanvas();
                    };
                    backgroundImageRef.src = backgroundImageUrl;
                } else {
                    backgroundImageRef.src = ''; // Limpia la fuente de la imagen
                    redrawCanvas();
                }
            }, (error) => {
                console.error(`Error al obtener la configuraci√≥n del tablero ${boardId}:`, error);
            });
        }

        // Funci√≥n para borrar todos los dibujos del tablero actual en Firestore
        async function clearCanvas() {
            playClickSound();
            if (!db || !currentBoardId) return;
            try {
                // Usa las funciones de Firestore directamente
                const strokesCollectionRef = collection(db, `artifacts/${appId}/public/data/boards/${currentBoardId}/strokes`);
                const snapshot = await getDocs(strokesCollectionRef);
                const deletePromises = [];
                snapshot.forEach((d) => {
                    deletePromises.push(deleteDoc(d.ref)); // Usa deleteDoc con la referencia del documento
                });
                await Promise.all(deletePromises); // Ejecuta todas las eliminaciones concurrentemente
                strokes = []; // Limpia el estado local inmediatamente
                redrawCanvas();
            } catch (error) {
                console.error("Error al borrar el lienzo:", error);
            }
        }

        // Funci√≥n para el bot√≥n "Guardar Dibujo"
        function handleSaveDrawing() {
            playClickSound();
            const saveMessageElement = document.getElementById('saveMessage');
            if (saveMessageElement) {
                saveMessageElement.textContent = '¬°Dibujo guardado!';
                saveMessageElement.classList.remove('hidden');
                setTimeout(() => {
                    saveMessageElement.classList.add('hidden');
                    saveMessageElement.textContent = '';
                }, 3000); // Borra el mensaje despu√©s de 3 segundos
            }
        }

        // Funci√≥n para establecer una imagen de fondo
        async function setBackgroundImage(imageUrl) {
            playClickSound();
            if (!db || !currentBoardId) return;
            try {
                // Usa las funciones de Firestore directamente
                const boardSettingsDocRef = doc(db, `artifacts/${appId}/public/data/boardSettings`, currentBoardId);
                await setDoc(boardSettingsDocRef, { backgroundImageUrl: imageUrl }, { merge: true });
            } catch (error) {
                console.error("Error al establecer la imagen de fondo:", error);
            }
        }

        // Funci√≥n para borrar la imagen de fondo
        async function clearBackgroundImage() {
            playClickSound();
            if (!db || !currentBoardId) return;
            try {
                // Usa las funciones de Firestore directamente
                const boardSettingsDocRef = doc(db, `artifacts/${appId}/public/data/boardSettings`, currentBoardId);
                await setDoc(boardSettingsDocRef, { backgroundImageUrl: null }, { merge: true });
            } catch (error) {
                console.error("Error al borrar la imagen de fondo:", error);
            }
        }

        // --- Funciones de Renderizado ---
        // Renderiza la pantalla de inicio con los botones de selecci√≥n de pizarra
        function renderHomePage() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl">
                    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
                        Pizarra del Taller: Afrontamiento del Estr√©s
                        <br />
                        <span class="text-xl text-gray-600">Universidad Virtual CNCI</span>
                    </h1>
                    <div id="boardButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <!-- Los botones se a√±adir√°n aqu√≠ din√°micamente -->
                    </div>
                </div>
            `;

            const boardButtonsContainer = document.getElementById('boardButtons');
            for (let i = 1; i <= 20; i++) {
                const button = document.createElement('button');
                button.className = "px-4 py-3 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transform hover:scale-105";
                button.textContent = `Pizarra ${i} üé®`;
                button.onclick = () => {
                    playClickSound();
                    currentBoardId = `pizarra-${i}`;
                    renderApp(); // Vuelve a renderizar para mostrar el tablero de dibujo
                };
                boardButtonsContainer.appendChild(button);
            }
        }

        // Renderiza el tablero de dibujo para la pizarra seleccionada
        function renderDrawingBoard() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl">
                    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Pizarra: ${currentBoardId}</h1>

                    ${userId ? `<p class="text-sm text-gray-600 text-center mb-4">
                        Tu ID de Usuario: <span class="font-mono bg-gray-200 px-2 py-1 rounded-md">${userId}</span>
                    </p>` : ''}

                    <div class="flex flex-wrap justify-center gap-4 mb-6">
                        <label for="colorPicker" class="flex items-center space-x-2">
                            <span class="text-gray-700">Color:</span>
                            <input type="color" id="colorPicker" value="${color}"
                                class="w-10 h-10 rounded-md cursor-pointer border border-gray-300 transition-all duration-200" />
                        </label>

                        <label for="brushSize" class="flex items-center space-x-2">
                            <span class="text-gray-700">Tama√±o del Pincel:</span>
                            <input type="range" id="brushSize" min="1" max="20" value="${brushSize}"
                                class="w-24 h-8 cursor-pointer accent-blue-500 transition-all duration-200" />
                            <span id="brushSizeValue" class="text-gray-700">${brushSize}px</span>
                        </label>

                        <div class="flex flex-wrap gap-2">
                            ${backgroundImages.map(img => `
                                <button onclick="setBackgroundImage('${img.url}')"
                                    class="px-4 py-2 bg-purple-500 text-white rounded-md shadow-md hover:bg-purple-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 transform hover:scale-105">
                                    ${img.name}
                                </button>
                            `).join('')}
                            <button onclick="clearBackgroundImage()"
                                class="px-4 py-2 bg-orange-500 text-white rounded-md shadow-md hover:bg-orange-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 transform hover:scale-105">
                                Quitar Fondo üö´
                            </button>
                        </div>

                        <button onclick="clearCanvas()"
                            class="px-6 py-2 bg-red-500 text-white rounded-md shadow-md hover:bg-red-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transform hover:scale-105">
                            Borrar Pizarra üóëÔ∏è
                        </button>

                        <button onclick="handleSaveDrawing()"
                            class="px-6 py-2 bg-green-500 text-white rounded-md shadow-md hover:bg-green-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transform hover:scale-105">
                            Guardar Dibujo ‚úÖ
                        </button>

                        <button onclick="playClickSound(); currentBoardId = null; renderApp();"
                            class="px-6 py-2 bg-gray-500 text-white rounded-md shadow-md hover:bg-gray-600 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transform hover:scale-105">
                            Regresar a Inicio üè†
                        </button>
                    </div>

                    <p id="saveMessage" class="text-center text-green-600 font-semibold mb-4 hidden animate-fade-in-out"></p>

                    <div class="relative w-full h-96 border-2 border-gray-300 rounded-lg overflow-hidden bg-white">
                        <canvas id="drawingCanvas"
                            class="absolute top-0 left-0 w-full h-full cursor-crosshair"></canvas>
                    </div>
                </div>
            `;

            // Adjunta los listeners de eventos despu√©s de renderizar el HTML
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseleave', stopDrawing);
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);
                canvas.addEventListener('touchcancel', stopDrawing);
            }

            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker) {
                colorPicker.addEventListener('change', (e) => {
                    color = e.target.value;
                });
            }

            const brushSizeInput = document.getElementById('brushSize');
            if (brushSizeInput) {
                brushSizeInput.addEventListener('input', (e) => {
                    brushSize = parseInt(e.target.value);
                    document.getElementById('brushSizeValue').textContent = `${brushSize}px`;
                });
            }

            // A√±ade el listener de redimensionamiento de la ventana
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // Redimensionamiento inicial

            // Configura los listeners de Firestore para el tablero actual
            setupBoardListeners(currentBoardId);
        }

        // Funci√≥n principal para renderizar la aplicaci√≥n (pantalla de inicio o tablero de dibujo)
        function renderApp() {
            if (currentBoardId === null) {
                renderHomePage();
            } else {
                renderDrawingBoard();
            }
        }

        // Configuraci√≥n inicial al cargar la ventana
        window.onload = () => {
            initializeFirebase();
            initializeSynth();
            renderApp();
        };
    </script>
</body>
</html>
